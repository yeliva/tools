<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faktur Pesanan - Roviana Printing</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fff">
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&amp;family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 32px;
            box-sizing: border-box;
            font-size: 12pt;
        }
        
        .invoice-container {
            width: 100%;
            max-width: 1123px;
            background: #fff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
        }
        .invoice-body {
            padding: 38px;
            flex-grow: 1;
        }

        .invoice-container, .invoice-container td, .invoice-container th, .invoice-container input, .invoice-container label, .invoice-container button {
            font-size: 12pt;
        }
        .contact-details p {
            font-size: 9pt;
            margin-top:-9px;
        }
        .signature-area p {
            font-size: 12pt;
            font-weight: 600;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }
        .company-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .contact-details {
            margin-top: 24px;
            color: #4b5563;
        }
        .invoice-title {
            font-size: 27pt;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            margin-top: 0;
        }
        .dotted-input-container {
            display: flex;
            align-items: center;
            margin-top:2px;
        }
        .dotted-input-container label {
            width: 100px;
            flex-shrink: 0;
            margin-right: 10px;
        }
        .dotted-input-container input {
            border: none;
            border-bottom: 1px dotted #374151;
            width: 100%;
            padding: 2px 0;
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
        }
        .dotted-input-container input[readonly] {
            background-color: #f9fafb;
            color: #4b5563;
        }
        .dotted-input-container input:focus {
            outline: none;
            border-bottom-style: solid;
            border-bottom-color: #3b82f6;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 55px;
        }
        .main-table th, .main-table td {
            border: 1px solid #d1d5db;
            padding: 8px;
            height: 23px;
            box-sizing: content-box;
        }
        .main-table th {
            background-color: #f9fafb;
            text-align: center;
            font-weight: 600;
        }
        .main-table th.col-no { width: 8.33%; }
        .main-table th.col-nama { width: 41.66%; }
        .main-table th.col-lain { width: 16.67%; }
        .main-table .table-input {
            width: 100%;
            border: none;
            padding: 0 4px;
            background-color: transparent;
        }
        .main-table .table-input:focus {
            outline: none;
            background-color: #eff6ff;
        }
        .cell-center { text-align: center; }
        .cell-right { text-align: right; }

        .table-controls {
            margin-top: 16px;
            display: flex;
            gap: 8px;
        }
        .btn {
            font-weight: 700;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            color: white;
            cursor: pointer;
        }
        .btn-add {
            font-size: 10.5pt;
            background-color: #6366f1;
        }
        .btn-add:hover { background-color: #4f46e5; }
        .btn-remove {
            font-size: 10.5pt;
            background-color: #ef4444;
        }
        .btn-remove:hover { background-color: #dc2626; }
        .action-buttons {
            margin-top: 32px;
            display: flex;
            gap: 16px;
        }
        .btn-full {
            width: 100%;
            padding: 15px 24px;
        }
        .btn-save { background-color: #3b82f6; }
        .btn-save:hover { background-color: #2563eb; }
        .btn-print { background-color: #22c55e; }
        .btn-print:hover { background-color: #16a34a; }
        
        .invoice-footer {
            margin-top: 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .signature-area .stamp {
            margin-top: 12px;
            margin-left: 8px;
            height: 80px;
            width: 80px;
            transform: rotate(-10deg);
        }
        .summary-wrapper {
            width: 33.33%;
        }
        .summary-box {
            background-color: #f9fafb;
            padding: 8px;
            border-radius: 8px;
        }
        .summary-table {
            width: 100%;
        }
        .summary-table td {
            padding: 6px;
        }
        .summary-table .label {
            text-align: left;
            font-weight: 700;
            color: #1f2937;
            white-space: nowrap;
        }
        .summary-table .value {
            text-align: right;
            font-weight: 500;
        }
        .summary-table .value-bold {
            font-weight: 700;
        }
        #uang-muka {
            border: none;
            background-color: transparent;
            padding: 0;
            width: 100%;
            text-align: right;
            font-weight: 500;
        }
        #uang-muka:focus {
            outline: none;
        }
        .main-table .table-input,
        .summary-table .value,
        .main-table .total,
        .row-number,
        #uang-muka,
        #invoice-number {
            font-family: 'Roboto Mono', monospace;
        }
        
        @page {
            size: A4 landscape;
            margin: 38px;
        }
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                display: block;
                min-height: unset;
                align-items: unset;
            }
            .invoice-container {
                max-width: 100%;
                box-shadow: none;
            }
            .dotted-input-container input {
                border-bottom: none;
            }
            .table-controls, .action-buttons {
                display: none;
            }
            .sembunyikan-saat-cetak {
                display: none !important;
            }
            .main-table th, .summary-box {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 0;
                align-items: flex-start;
            }
            .invoice-container {
                min-height: 100vh;
                box-shadow: none;
            }
            .invoice-body {
                padding: 16px;
            }
            .invoice-header {
                flex-direction: column;
                gap: 20px;
            }
            .client-info {
                width: 100%;
            }
            .invoice-title {
                font-size:22pt;
                text-align:left;
            }
            .dotted-input-container label {
                width: 80px;
            }
            .main-table thead {
                display: none;
            }
            .main-table tr {
                display: block;
                border: 1px solid #ddd;
                border-radius: 8px;
                margin-bottom: 16px;
                padding: 10px;
            }
            .main-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: none;
                border-bottom: 1px solid #eee;
                padding: 10px 5px;
                text-align: right;
            }
            .main-table td:last-child {
                border-bottom: none;
            }
            .main-table td::before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                padding-right: 10px;
            }
            .main-table .table-input {
                width: 50%;
            }
            .invoice-footer {
                flex-direction: column-reverse;
                align-items: flex-start;
                gap: 32px;
            }
            .summary-wrapper {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="invoice-body">
            <header class="invoice-header">
                <div class="company-info"> 
                    <img src="https://raw.githubusercontent.com/yeliva/faktur/main/images/logo_rp.svg" alt="Logo Roviana Printing" width="260">
                    <div class="contact-details">
                        <p>0853 2230 7373</p>
                        <p>www.rovianaprinting.com</p>
                        <p>Jl. Waru No. 14 Rawamangun, Jakarta Timur</p>
                    </div>
                </div>
                <div class="client-info">
                    <h1 class="invoice-title">FAKTUR PESANAN</h1>
                    <div class="dotted-input-container">
                        <label for="invoice-number">No. Faktur</label>
                        <input type="text" id="invoice-number" readonly>
                    </div>
                    <div class="dotted-input-container">
                        <label for="client-name">Kepada Yth,</label>
                        <input type="text" id="client-name">
                    </div>
                    <div class="dotted-input-container">
                        <label for="invoice-date">Tgl.</label>
                        <input type="text" id="invoice-date">
                    </div>
                    <div class="dotted-input-container">
                        <label for="client-phone">Tlp.</label>
                        <input type="text" id="client-phone">
                    </div>
                </div>
            </header>

            <main>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="col-no">No</th>
                            <th class="col-nama">NAMA PESANAN</th>
                            <th class="col-lain">BANYAK</th>
                            <th class="col-lain">HARGA SATUAN</th>
                            <th class="col-lain">JUMLAH</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items">
                        </tbody>
                </table>
                <div class="table-controls">
                    <button id="add-row" class="btn btn-add">+ Tambah Baris</button>
                    <button id="remove-row" class="btn btn-remove">- Kurangi Baris</button>
                </div>
            </main>

            <footer class="invoice-footer">
                <div class="signature-area">
                    <p>Hormat Kami,</p>
                    <img src="https://raw.githubusercontent.com/yeliva/faktur/main/images/rp_stempel_merah.png" alt="Stempel Original" class="stamp"> 
                </div>
                <div class="summary-wrapper">
                    <div class="summary-box">
                        <table class="summary-table">
                            <tr id="subtotal-row">
                                <td class="label">Jumlah</td>
                                <td class="value" id="subtotal"></td>
                            </tr>
                            <tr id="dp-row">
                                <td class="label">Uang Muka</td>
                                <td class="value">
                                    <input type="text" id="uang-muka" oninput="formatInputField(event)">
                                </td>
                            </tr>
                            <tr id="sisa-row">
                                <td class="label">Sisa</td>
                                <td class="value value-bold" id="sisa"></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </footer>
            
            <div class="action-buttons">
                <button id="save-button" class="btn btn-full btn-save">Simpan ke Sheet</button>
                <button id="print-only-button" class="btn btn-full btn-print">Cetak Faktur</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

   <script>
        document.addEventListener('DOMContentLoaded', function () {
            function generateInvoiceNumber() {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `INV/${year}${month}${day}/${hours}${minutes}`;
            }

            document.getElementById('invoice-number').value = generateInvoiceNumber();
            
            const flatpickrConfig = {
                dateFormat: "d/m/Y",
                defaultDate: "today",
                allowInput: true
            };
            let flatpickrInstance = flatpickr("#invoice-date", flatpickrConfig);

            const clientNameInput = document.getElementById('client-name');
            const originalTitle = document.title;
            clientNameInput.addEventListener('input', function() {
                const clientName = this.value.trim(); 
                if (clientName) {
                    const clientInitial = clientName.substring(0, 3).toUpperCase();
                    document.title = `FAK[${clientInitial}]-Roviana Printing`;
                } else {
                    document.title = originalTitle;
                }
            });

            function formatRupiah(angka) {
                if(isNaN(angka) || angka === 0) return '';
                return 'Rp ' + new Intl.NumberFormat('id-ID').format(angka);
            }

            function parseRupiah(rupiahString) {
                if (typeof rupiahString !== 'string') return 0;
                return Number(rupiahString.replace(/[^0-9]/g, ''));
            }

            window.calculateTotal = function () {
                let subtotal = 0;
                document.querySelectorAll('#invoice-items tr').forEach(row => {
                    const qtyInput = row.querySelector('.input-qty');
                    const priceInput = row.querySelector('.input-price');
                    const totalCell = row.querySelector('.total');
                    if (qtyInput && priceInput && totalCell) {
                        const qty = parseFloat(qtyInput.value) || 0;
                        const price = parseRupiah(priceInput.value) || 0;
                        const lineTotal = qty * price;
                        totalCell.textContent = formatRupiah(lineTotal);
                        subtotal += lineTotal;
                    }
                });

                const uangMuka = parseRupiah(document.getElementById('uang-muka').value) || 0;
                document.getElementById('subtotal').textContent = formatRupiah(subtotal);
                document.getElementById('sisa').textContent = formatRupiah(subtotal - uangMuka);
            };
            
            window.formatInputField = function(e) {
                const value = parseRupiah(e.target.value);
                e.target.value = 'Rp ' + new Intl.NumberFormat('id-ID').format(value);
                calculateTotal();
            };

            function renumberRows() {
                document.querySelectorAll('#invoice-items tr').forEach((row, index) => {
                    const numberCell = row.cells[0].querySelector('.row-number');
                    if (numberCell) {
                        numberCell.textContent = index + 1;
                    }
                });
            }

            function addRow() {
                const tbody = document.getElementById('invoice-items');
                const newRow = tbody.insertRow();
                newRow.innerHTML = `
                    <td data-label="No" class="cell-center"><span class="row-number"></span></td>
                    <td data-label="Nama Pesanan"><input type="text" class="table-input input-nama" placeholder="..."></td>
                    <td data-label="Banyak"><input type="text" class="table-input input-qty cell-center" oninput="calculateTotal()"></td>
                    <td data-label="Harga Satuan"><input type="text" class="table-input input-price cell-right" oninput="formatInputField(event)"></td>
                    <td data-label="Jumlah" class="cell-right"><span class="total"></span></td>
                `;
                renumberRows();
                calculateTotal();
            }

            document.getElementById('add-row').addEventListener('click', addRow);
            document.getElementById('remove-row').addEventListener('click', function() {
                const tbody = document.getElementById('invoice-items');
                if (tbody.rows.length > 0) {
                    tbody.deleteRow(-1);
                    calculateTotal();
                }
            });

            for(let i=0; i<1; i++) { addRow(); }
            calculateTotal();

            
            async function simpanKeSheet() {
                const items = [];
                document.querySelectorAll('#invoice-items tr').forEach(row => {
                    const namaPesanan = row.querySelector('.input-nama').value;
                    if (namaPesanan) {
                        items.push({
                            nama: namaPesanan,
                            banyak: row.querySelector('.input-qty').value,
                            harga: row.querySelector('.input-price').value,
                            jumlah: row.querySelector('.total').textContent
                        });
                    }
                });

                const invoiceData = {
                    nomorFaktur: document.getElementById('invoice-number').value,
                    tanggal: document.getElementById('invoice-date').value,
                    kepada: document.getElementById('client-name').value,
                    telepon: document.getElementById('client-phone').value,
                    items: items
                };
                
                const url = 'https://script.google.com/macros/s/AKfycby67XUBRaaNmjoHVbbswc4JyXN5sm9wL01GPIVhewikrTHtkP1hLkJCW0Xn1NrafVeHyA/exec';

                try {
                    await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(invoiceData),
                        mode: 'no-cors'
                    });
                    
                    Toastify({
                        text: "âœ” Data berhasil disimpan ke Google Sheets!",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                    }).showToast();
                } catch (error) {
                    console.error('Terjadi kesalahan jaringan, data tidak dapat dikirim.', error);
                    
                    Toastify({
                        text: "Gagal menyimpan. Periksa koneksi internet Anda.",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        style: { background: "#ef4444" }
                    }).showToast();
                }
            }
            
            const saveButton = document.getElementById('save-button');
            if (saveButton) {
                saveButton.addEventListener('click', function(event){
                    event.preventDefault();
                    simpanKeSheet();
                });
            }

            const printOnlyButton = document.getElementById('print-only-button');
            if (printOnlyButton) {
                printOnlyButton.addEventListener('click', function(event){
                    event.preventDefault();
                    window.print();
                });
            }

            window.addEventListener('beforeprint', () => {
                if (flatpickrInstance) {
                    flatpickrInstance.destroy();
                }
                const uangMukaValue = parseRupiah(document.getElementById('uang-muka').value) || 0;
                if (uangMukaValue === 0) {
                    document.getElementById('dp-row').classList.add('sembunyikan-saat-cetak');
                    document.getElementById('sisa-row').classList.add('sembunyikan-saat-cetak');
                }
            });

            window.addEventListener('afterprint', () => {
                flatpickrInstance = flatpickr("#invoice-date", flatpickrConfig);
                document.getElementById('dp-row').classList.remove('sembunyikan-saat-cetak');
                document.getElementById('sisa-row').classList.remove('sembunyikan-saat-cetak');
            });
        });         
    </script>
</body>
</html>
